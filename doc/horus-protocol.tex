\documentclass[11pt]{article}

\usepackage{times,fullpage}
\usepackage{xspace}

\newcommand{\mds}{\ensuremath{\mathit{MDS}}}
\newcommand{\kds}{\ensuremath{\mathit{KDS}}}


\begin{document}

This protocol is between metadata server ($\mds$), client ($C$), and
key distribution server ($\kds$) for a file with root key $K_R$ and
user $A$.  We assume that $\kds$ is given private key
$\textit{KR}_A$, which is paired with public key $\textit{KU}_A$.

\vspace{1ex}

The file in question is owned by the application $A$, and we want
to allow the full access permission to the file only to the
user $A$ and the trusted $\kds$.
In other words, both $C$ and $\mds$ are not
allowed to access the entire file, since both $C$ (i.e., a computation
node in a supercomputer system) and $\mds$ may be managed by a
company that is different from the entity that is trying to run
the application $A$ on the supercomputer.
Hence, the $\mds$ should not have the file's master key $K_R$.

The block size $bs$, the depth of the key hash tree $d$,
and the accessible block number $(i,j)$ for a client $C$,
which collectively determin the allowable range for $C$,
are decided by either $\kds$ or $A$.
The range parameters $(bs,d,i,j,C)$ for the file are
either stored in $\mds$ or in $\kds$.

$\mds$ is trusted in a level that $\mds$ is tamper-proof;
if $\kds$ or $A$ store the range parameters $(bs,d,i,j,C)$,
they must provide the correct value to the correct entity.
If $\mds$ is compromised, it could alter the owner of the file,
meaning that there is no point in worring about range alteration
in $\mds$.

We assume That ID theft or spoofing is securely prohitited by the system.
$C$ cannot impersonate $\mds$ or $\kds$ in the system.

To counteract against an alteration of allowable range by $C$ or
a replay attack after range update in the system,
$\kds$ must not be provided the range parameters by $C$.
This means that $\kds$ must either 1) have a database storing allowable
ranges for each clients $C$ and for each files, or
2) directly talk with $\mds$ to retrieve the range parameter for the file.
This document assumes 2) for ease of implementation.

$\mds$ provides the attributes of the file; i.e., the owner, permissions
(modes), the key-hash parameter for the file $(bs,d)$,
permitted range $(i,j)$ for a client $C$.
The file attributes are generally open to public, meaning that $\mds$
does not authenticate clients nor need to have clients' IDs.
$\mds$ does not need to distinguish $\kds$ from $C$.
$\mds$ may provide storage service for the keys managed by $\kds$;
$\mds$ may hold in an extended attribute the master key $K_R$
encrypted by $\kds$'s public key $KU_{\kds}$ or $A$'s public key $KU_{A}$.
In this way $\mds$ cannot have $K_R$ and hence cannot have
the full access to the file.
$\mds$ can be implemented as the meta data server in Ceph
or extended attributes (or "\textit{forks}") in other file systems.

\begin{eqnarray*}
   \mds & : & \mbox{a meta data server.} \\
   C    & : & \mbox{a client or a computation node.} \\
   \kds & : & \mbox{a key distribution server.} \\
   A    & : & \mbox{a user or an application.} \\
   \textit{KR}_A & : & \mbox{the private key for $A$.} \\
   \textit{KU}_A & : & \mbox{the public key for $A$.} \\
   (bs,d,i,j) & : & \mbox{block size $bs$, depth $d$, range $i,j$.} \\
\end{eqnarray*}

Resulting key exchange protocol in Horus is as follows.

Key exchange in read request:
\begin{eqnarray}
  C \rightarrow \kds & : & \mbox{open request} \\
  \kds \rightarrow \mds & : & \mbox{request: file path, } C \\
  \mds \rightarrow \kds & : & \mbox{range attributes: }
    \{ bs,d,C,i,j,E_{KU_A}(K_R) \} \\
  \kds & : & \mbox{key calculation for } C \\
  \kds \rightarrow C & : & K_{i,j} \\
  C \rightarrow OSD & : & \mbox{file access (read/write)} \\
  C & : & \mbox{decrypt data}
\end{eqnarray}

\begin{tabular}{l}
  $A@\kds$\verb+% horus-config public-key +$KU_A$ \\
  $A@\kds$\verb+% horus-config private-key +$KR_A$ \\
  $A@\kds$\verb+% horus-config file +\textit{path}\verb+ master-key +$K_R$ \\
  $A@\kds$\verb+% horus-config file +\textit{path}\verb+ block-size +$bs$ \\
  $A@\kds$\verb+% horus-config file +\textit{path}\verb+ key-tree-depth +$d$ \\
  $A@\kds$\verb+% horus-config file +\textit{path}\verb+ client +$C$\verb+ allowed-block +$i,j$
\end{tabular}

\end{document}

